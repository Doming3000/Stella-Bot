import { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder } from "discord.js";
import dotenv from 'dotenv';
import axios from "axios";

// Cargar variables de entorno
dotenv.config();

export const data = new SlashCommandBuilder()
.setName('malware-scan')
.setDescription('Analiza una URL en busca de malware.')
.addStringOption(option =>
  option.setName('url')
  .setDescription('URL a analizar.')
  .setRequired(true)
)

// Función para verificar si una URL es válida
function isValidURL(url) {
  try {
    new URL(url);
    return true;
  } catch (error) {
    return false;
  }
}

// Función para crear un delay para el análisis
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Función para manejar errores de la API
async function handleAPIError(error) {
  const response = error.response;
  
  switch (response.status) {
    case 429: {
      await interaction.editReply({ content: "<:Advertencia:1302055825053057084> Se están haciendo demasiadas peticiones, inténtalo nuevamente más tarde.", allowedMentions: { repliedUser: false }});
      return;
    }
    default:
    await interaction.editReply({ content: "<:Advertencia:1302055825053057084> Ha ocurrido un error inesperado.", allowedMentions: { repliedUser: false }});
    return;
  }
}

// Función run (comando principal)
export async function run(client, interaction) {
  const url = interaction.options.getString('url');
  
  // Verificar si el valor proporcionado es una URL válida.
  if (!isValidURL(url)) {
    await interaction.reply({ content: "<:Advertencia:1302055825053057084> Debes proporcionar una URL válida.", flags: 64, allowedMentions: { repliedUser: false }});
    return;
  }
  
  // Mensaje de confirmación
  interaction.reply({ content: "<:Done:1326292171099345006> **Recibido**. Se está analizando este enlace <a:Loading:1374508429930139780>\n-# Esto puede tardar algún tiempo.", allowedMentions: { repliedUser: false }});
  
  try {
    // Obtener la clave API de VirusTotal
    const apiKey = process.env.VIRUSAPIKEY;
    const virusTotalUrl = `https://www.virustotal.com/api/v3/urls`;
    
    // Paso 1: Enviar la URL para el análisis
    const analysisResponse = await axios.post( virusTotalUrl, `url=${url}`, { headers: { 'x-apikey': apiKey, 'Content-Type': 'application/x-www-form-urlencoded' }});
    const analysisId = analysisResponse.data.data.id;
    const resultUrl = `https://www.virustotal.com/api/v3/analyses/${analysisId}`;
    
    // Paso 2: Consultar el estado del análisis
    let analysisStatus = 'queued';
    const maxRetries = 10;
    let retryCount = 0;
    let resultResponse;
    
    while (analysisStatus !== 'completed' && retryCount < maxRetries) {
      try {
        await delay(5000);
        resultResponse = await axios.get(resultUrl, { headers: { 'x-apikey': apiKey }});
        analysisStatus = resultResponse.data.data.attributes.status;
      } catch (error) {
        const { message } = await handleAPIError(error);
        console.warn(message);
        
        if (retry && retryCount < maxRetries) {
          await delay(delay);
          retryCount++;
        } else {
          throw new Error(message);
        }
      }
    }
    
    if (analysisStatus !== 'completed') {
      await interaction.editReply({ content: "<:Advertencia:1302055825053057084> El análisis no se completó en el tiempo esperado.", allowedMentions: { repliedUser: false }});
      throw new Error("El análisis no se completó en el tiempo esperado. ");
    }
    
    // Paso 3: Obtener resultados y meta información
    const analysisData = resultResponse.data.data.attributes;
    const urlMetaInfo = resultResponse.data.meta.url_info;
    const positives = analysisData.stats.malicious;
    const totalScans = analysisData.stats.undetected + analysisData.stats.malicious + analysisData.stats.suspicious;
    
    // Determinar el estado del enlace analizado
    const linkStatus = positives > 0 ? "No seguro" : "Seguro";
    
    if (!analysisData.results || !urlMetaInfo) {
      await interaction.editReply({ content: "<:Advertencia:1302055825053057084> No se encontraron resultados de análisis para esta URL.", allowedMentions: { repliedUser: false }});
      return;
    }
    
    // Generar el enlace público usando la ID del análisis
    const publicResultUrl = `https://www.virustotal.com/gui/url/${urlMetaInfo.id}/detection`;
    
    // Crear y enviar un embed con los resultados
    const embed = new EmbedBuilder()
    .setColor(positives > 0 ? '#eb5252' : '#68d268')
    .setAuthor({ name: `${client.user.username} - ${interaction.commandName}`, iconURL: client.user.displayAvatarURL()})
    .setTitle(`Análisis terminado: ${linkStatus}`)
    .addFields(
      { name: 'URL analizada', value: `\`${url}\``, inline: false},
      { name: 'Positivos', value: `${positives}/${totalScans}`, inline: true }
    )
    .setFooter({ text: positives > 0 ? 'No se recomienda acceder a esta URL.' : 'La URL es segura, puedes proceder.' });
    
    // Botón para abrir los resultados en el navegador.
    const actionRow = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
      .setEmoji("<:Lista:1327042288941137960>")
      .setLabel("Ver resultados")
      .setURL(`${publicResultUrl}`)
      .setStyle("Link")
    );
    
    // Editar el mensaje de confirmación
    await interaction.editReply({ content: "", embeds: [embed], components: [actionRow], allowedMentions: { repliedUser: false }});
    
    // Obtener el enlace del mensaje
    const originalMessage = await interaction.fetchReply();
    const messageLink = `https://discord.com/channels/${interaction.guildId}/${interaction.channelId}/${originalMessage.id}`;
    
    // Avisar al usuario
    await interaction.followUp({ content: `<:Done:1326292171099345006> <@${interaction.user.id}> El [análisis](${messageLink}) ha finalizado.`, flags: 64, allowedMentions: { repliedUser: false }});
  } catch (error) {
    console.error("Error al realizar el análisis de virus:", error.response ? error.response.data : error.message);
    await interaction.editReply({ content: "<:Advertencia:1302055825053057084> Ha ocurrido un error al ejecutar este comando.", allowedMentions: { repliedUser: false }});
  }
}